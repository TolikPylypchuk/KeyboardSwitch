#!/bin/bash

SYSTEMD_SERVICE=keyboard-switch
UNIT_FILE=/etc/systemd/user/$SYSTEMD_SERVICE.service
DESKTOP_FILE=/usr/share/applications/keyboard-switch.desktop

if [ -f $UNIT_FILE ] ; then
    systemctl --global disable $SYSTEMD_SERVICE

    for USER in "$(awk -F: '($3>=1000)&&($3<60000)&&($1!="nobody"){print $1}' /etc/passwd)"
    do
        sudo -H -u $USER XDG_RUNTIME_DIR=/run/user/$(id -u $USER) systemctl --user stop $SYSTEMD_SERVICE
    done

    rm $UNIT_FILE

    for USER in "$(awk -F: '($3>=1000)&&($3<60000)&&($1!="nobody"){print $1}' /etc/passwd)"
    do
        sudo -H -u $USER XDG_RUNTIME_DIR=/run/user/$(id -u $USER) systemctl --user daemon-reload
    done
fi

if [ -f "$DESKTOP_FILE" ] ; then
    rm "$DESKTOP_FILE"
    update-desktop-database
fi
